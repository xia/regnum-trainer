(function(d){function e(h,f,g){return h[f]||g}function c(){var n=this,g="abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNOPQRSTUVWXYZ",q=50,f={archer:16,hunter:17,marksman:18,mage:32,conjurer:33,warlock:34,warrior:64,barbarian:65,knight:66},l=["archer","hunter","marksman","mage","conjurer","warlock","warrior","barbarian","knight"],p=["1.6.2","1.7_beta1"],k=240,t=null,w=null,j=q,i=null;this.config={};this.load_data=function(y,x,A,z){var C=d.isFunction(A)?null:A,B=d.isFunction(A)?A:z;u(y);o(x);d.getJSON(i+"/trainerdata.json",function(E,D){v(E,C);if(d.isFunction(B)){B.apply(n)}})};this.encode=function(){var x=g.charAt(d.inArray(t,p))+g.charAt(d.inArray(w,l))+g.charAt(j-1);d.each(n.config.disciplines,function(A,z){var B,y;x+=g.charAt(z.current_level);for(B=1;B<=10;B+=2){y=z.spells[B-1].current_level*6+z.spells[B].current_level;x+=g.charAt(y)}});return x};this.decode=function(z,B){var y=p[Math.max(0,g.indexOf(z[0]))],x=l[Math.max(0,g.indexOf(z[1]))],A=Math.max(0,g.indexOf(z[2]))+1;n.load_data(y,x,A,function(){var C=0;d.each(n.config.disciplines,function(E,D){n.set_discipline_level(E,g.indexOf(z[C*6+3]));d.each(D.spells,function(F,G){var I=(C*6)+4+Math.floor(F/2),H=g.indexOf(z[I]),J=null;if(0==F%2){J=Math.floor(H/6)}else{J=H%6}n.set_power_level(E,F+1,J)});C++});s();if(d.isFunction(B)){B.apply(n)}})};this.is_valid=function(){return !(n.discipline_points_left()<0)&&!(n.power_points_left()<0)};this.reset_powers=function(){d.each(n.config.disciplines,function(y,x){n.set_discipline_level(y,n.config.min_discipline_level);d.each(x.spells,function(z,A){n.set_power_level(y,z+1,n.config.min_power_level)})});s()};this.set_discipline_level=function(y,z){var x=n.config.disciplines[y];if(x){x.current_level=Math.max(n.config.min_discipline_level,Math.min(n.config.max_discipline_level,z));x.current_power_limit=n.config.max_power_level[x.current_level-1];s()}};this.set_power_level=function(y,z,A){var x=n.config.disciplines[y];if(x){power=x.spells[z-1];power.current_level=Math.max(n.config.min_power_level,Math.min(x.current_power_limit,A));s()}};this.valid_discipline_level=function(x,y){return j>=n.config.discipline_required_character_level[y-1]&&n.discipline_point_cost(x,y)<=n.discipline_points_left()&&n.config.min_discipline_level<=y&&y<=n.config.max_discipline_level};this.discipline_point_cost=function(x,y){return n.config.discipline_required_points[y-1]-n.config.discipline_required_points[x.current_level-1]};this.discipline_points_left=function(){return n.config.discipline_points_total-n.config.discipline_points_used};this.power_limit=function(x,y){return(x.current_level>y*2)?x.current_power_limit:n.config.min_power_level};this.power_points_left=function(){return n.config.power_points_total-n.config.power_points_used};this.set_character_level=function(x){var y=parseInt(x);if(!isNaN(y)){j=Math.min(y,q)}else{j=q}h();s()};this.get_character_level=function(){return j};this.get_game_version=function(){return t};this.get_character_class=function(){return w};function u(x){if(d.inArray(x,p)>-1){t=x;i="trainer/"+t}}function o(x){var y=x.toLowerCase();if(d.inArray(y,l)){w=y}}function m(y,x){for(mask in y){if((parseInt(mask)&x)>0){return y[mask]}}}function v(x,A){var z=e(f,w,0),y={discipline_points_per_level:m(x.points.discipline,z),discipline_points_used:0,power_points_per_level:m(x.points.power,z),power_points_used:0,min_discipline_level:1,min_power_level:x.min_power_level,max_power_level:x.required.power,discipline_required_points:x.required.points,discipline_required_character_level:x.required.level,disciplines:{}};d.each(r(z,x),function(D,C){var B=x.disciplines[C];d.each(B.spells,function(E,F){d.extend(F,{current_level:y.min_power_level})});d.extend(B,{current_level:y.min_discipline_level,current_power_limit:y.max_power_level[y.min_discipline_level-1],icon_path:i+"/icons/"+C.replace(/ /g,"")+".jpg"});y.disciplines[C]=B});n.config=y;n.set_character_level(A)}function s(){var z=n.config.disciplines,y=0,x=0;d.each(z,function(B,A){A.current_level=Math.min(A.current_level,n.config.max_discipline_level);A.current_power_limit=n.config.max_power_level[A.current_level-1];y+=n.config.discipline_required_points[A.current_level-1];d.each(A.spells,function(C,D){D.current_level=Math.min(D.current_level,n.power_limit(A,C));x+=(D.current_level-n.config.min_power_level)})});n.config.discipline_points_used=y;n.config.power_points_used=x}function h(){var x=n.config;x.discipline_points_total=x.discipline_points_per_level[j-1];x.power_points_total=x.power_points_per_level[j-1];x.max_discipline_level=19;while(j<x.discipline_required_character_level[x.max_discipline_level-1]){x.max_discipline_level-=2}}function r(A,z){var y=A&k,x=e(z.class_disciplines,y,[]);if(y!=A){x=x.concat(e(z.class_disciplines,A,[]))}return x}}function a(){var o=this,k="edit_mode_control",f="view_mode_control",h="view_mode_data",g="#trainer select, #tool_options select";this.setup=new c();this.load_data=function(q,r,p,s){this.setup.load_data(q,r,p,function(){n();if(d.isFunction(s)){s.apply(o)}})};this.decode=function(p,q){o.setup.decode(p,function(){n();o.reset_events();if(d.isFunction(q)){q.apply(o)}})};this.set_edit_mode=function(){d("#comments").remove();d("."+f).hide();d("."+k).show();d("."+h).remove();d(g).show()};this.set_view_mode=function(){if(o.setup.is_valid()){d("."+f).show();d("."+k).hide();d(g).each(function(){var q=d(this),r=q.parent();r.append(d("<span>").addClass(h).text(q.find("option:selected").text()));q.hide()})}else{o.set_edit_mode()}};this.reset_powers=function(p){o.setup.reset_powers();m()};this.set_character_level=function(p){o.setup.set_character_level(p);m()};this.set_discipline_level=function(p,q){o.setup.set_discipline_level(p,q);m()};this.set_power_level=function(p,q,r){o.setup.set_power_level(p,q,r);m()};this.increase_discipline_level=function(s){var r=d(this).parents(".metadata"),q=r.find(".name").text(),p=parseInt(r.find(".level").text());if(d(this).hasClass("disabled")){if(p==o.setup.config.max_discipline_level){o.notify_error("Discipline is at maximum level")}else{o.notify_error("Not enough discipline points")}}else{o.set_discipline_level(q,p+2)}};this.decrease_discipline_level=function(s){if(d(this).hasClass("disabled")){o.notify_error("Discipline is at minimum level")}else{var r=d(this).parents(".metadata"),q=r.find(".name").text(),p=parseInt(r.find(".level").text());o.set_discipline_level(q,p-2)}};this.increase_power_level=function(v){var u=d(this).parents(".discipline"),r=u.find(".name").text(),q=o.setup.config.disciplines[r],t=d(this).parents(".power"),s=u.find(".power").index(t)+1,p=parseInt(t.find(".level").text());if(d(t).hasClass("available")){if(d(this).hasClass("disabled")){if(p==q.current_power_limit){o.notify_error("Power is at maximum level")}else{o.notify_error("Not enough power points")}}else{o.set_power_level(r,s,p+1)}}};this.decrease_power_level=function(r){var q=d(this).parents(".discipline"),p=q.find(".name").text();power=d(this).parents(".power"),power_index=q.find(".power").index(power)+1,power_level=parseInt(power.find(".level").text());if(d(power).hasClass("available")){if(d(this).hasClass("disabled")){o.notify_error("Power is at minimum level")}else{o.set_power_level(p,power_index,power_level-1)}}};this.permalink=function(){return window.location.protocol+"//"+window.location.host+window.location.pathname+"?s="+o.setup.encode()};this.update_permalink=function(){var q=d("#permalink");if(o.setup.is_valid()){q.show()}else{q.hide()}return q.attr("href",o.permalink())};this.reset_events=function(){d(".discipline .metadata .increase_level").click(o.increase_discipline_level);d(".discipline .metadata .decrease_level").click(o.decrease_discipline_level);d(".discipline .powers .increase_level").click(o.increase_power_level);d(".discipline .powers .decrease_level").click(o.decrease_power_level);d(".power").each(function(p,q){d(q).cluetip({local:true,positionBy:"bottomTop"})});d("#cluetip-outer").addClass("ui-widget");d("#cluetip-title").addClass("ui-widget-header");d("#cluetip-inner").addClass("ui-widget-content");d("#trainer").fadeIn()};this.notify_error=function(p){d("#statusbar").addClass("ui-state-error").text(p).slideDown("fast",function(){setTimeout(function(){d("#statusbar").slideUp("slow")},1800)})};function n(){var p=o.setup,q=d("#trainer_ui");q.empty();d.each(p.config.disciplines,function(x,s){var u=x.replace(/ /g,"_"),w=d("<div>").addClass("name"),r=d("<div>").addClass("icon").css("background-image","url('"+s.icon_path+"')").append(d("<div>").addClass("level")),v=d("<div>").addClass("ui-icon"),y=d("<div>").addClass("controls").addClass(k).append(v.clone().addClass("increase_level ui-icon-triangle-1-n")).append(v.clone().addClass("decrease_level ui-icon-triangle-1-s")),t=d("<div>").addClass("powers"),z=d("<div>").addClass("discipline discipline_"+u);z.append(d("<div>").addClass("metadata").append(w.text(x)).append(r.clone()).append(y.clone()));d.each(s.spells,function(B,C){var E=C.name.replace(/ /g,"_"),A=u+"-"+E.replace(/[^A-Za-z0-9]/g,"_"),D=d("<div>").addClass("power p"+(B+1)).attr("title",C.name).attr("rel","#"+A);D.append(r.clone());D.append(y.clone());t.append(D);t.append(j(C).attr("id",A))});z.append(t);q.append(z)});m()}function m(){var p=o.setup,q=d("#trainer_metadata");d("#char_level").val(p.get_character_level());q.find(".discipline_points .left").text(p.discipline_points_left());q.find(".discipline_points .total").text(p.config.discipline_points_total);if(p.discipline_points_left()<0){q.find(".discipline_points").addClass("invalid")}else{q.find(".discipline_points").removeClass("invalid")}q.find(".power_points .left").text(p.power_points_left());q.find(".power_points .total").text(p.config.power_points_total);if(p.power_points_left()<0){q.find(".power_points").addClass("invalid")}else{q.find(".power_points").removeClass("invalid")}o.update_permalink();d(".discipline").each(function(t,u){var s=d(u).find(".name").text(),r=p.config.disciplines[s];d(u).find(".level").text(r.current_level);d(u).find(".metadata .ui-icon.disabled").removeClass("disabled");if(p.config.min_discipline_level==r.current_level){d(u).find(".metadata .ui-icon-triangle-1-s").addClass("disabled")}if((p.config.max_discipline_level==r.current_level)||!p.valid_discipline_level(r,r.current_level+2)){d(u).find(".metadata .ui-icon-triangle-1-n").addClass("disabled")}d(u).find(".power").each(function(w,v){var x=w*2+1;power_limit=p.power_limit(r,w),power=r.spells[w];d(v).find(".level").text(power.current_level);d(v).removeClass("available activated valid invalid");if(x<=r.current_level){d(v).addClass("available");if(power.current_level>0){d(v).addClass("activated")}}if(p.valid_discipline_level(r,(w*2)+1)){d(v).addClass("valid")}else{d(v).addClass("invalid")}d(v).find(".ui-icon.disabled").removeClass("disabled");if(p.config.min_power_level==power.current_level){d(v).find(".ui-icon-triangle-1-s").addClass("disabled")}if(power.current_level==power_limit||0>=o.setup.power_points_left()){d(v).find(".ui-icon-triangle-1-n").addClass("disabled")}})})}function j(p){var q=d("<div>").addClass("tooltip");q.append(d("<div>").addClass("description").text(p.description));if(p.damage){q.append(l("Damage",p.damage).addClass("damage"))}specs=d("<div>").addClass("specs");specs.append(l("Type",p.type||"Unknown"));if(p.type&&p.type!="Passive"){if(p.duration){specs.append(l("Duration",p.duration))}specs.append(l("Cost",p.mana));specs.append(l("Casting",p.cast||"Instant"));specs.append(l("Cooldown",p.cooldown||"Unknown"));if(p.gcd){specs.append(l("GCD",p.gcd||"Unknown"))}if(p.range){specs.append(l("Range",p.range||"Weapon Range"))}if(p.area){specs.append(l("Area",p.area))}}if(p.buffs){specs.append(l("",p.buffs).addClass("buffs"))}if(p.debuffs){specs.append(l("",p.debuffs).addClass("debuffs"))}q.append(specs);return q}function l(q,p){var t=d("<div>"),r=d("<label>").text(q+":").addClass("spec_label"),s=d("<div>");if(typeof p=="string"||typeof p=="number"){s.append(p)}else{if(d.isArray(p)){d.each(d.map(p,i),function(u,v){if(u>0){s.append(", ")}s.append(v)})}else{r.removeClass("spec_label");for(spec in p){if(p[spec]===true){s.append(spec)}else{s.append(l(spec,p[spec]))}}}}if(q){t.append(r)}return t.append(s)}function i(q,p){return d("<span>").addClass("l"+(p+1)).text(q)}}var b=new a();d(function(){d("#trainer").hide();d("#trainer_actions a").button();d("body").append(d("<span>").attr("id","statusbar").addClass("ui-state-hidden"));d("#tool_option_submit").click(function(){if(!d("#game_version").val()){d("#game_version").effect("highlight",{},2000);b.notify_error("Please select a game version.")}else{if(!d("#char_class").val()){d("#char_class").effect("highlight",{},2000);b.notify_error("Please select a character class.")}else{if(!d("#char_level").val()){d("#char_level").effect("highlight",{},2000);b.notify_error("Please select a character level.")}else{d("#trainer").hide();b.load_data(d("#game_version").val(),d("#char_class").val(),d("#char_level").val(),b.reset_events)}}}return false});d("#char_level").change(function(){b.set_character_level(d(this).val())});d("#edit_setup").click(function(){b.set_edit_mode();return false});d("#reset_powers").click(function(){b.reset_powers();return false});if(d.query.get("s")){b.decode(d.query.get("s"),function(){d("#game_version").val(b.setup.get_game_version());d("#char_class").val(b.setup.get_character_class());b.set_view_mode()})}else{b.set_edit_mode()}})})(jQuery);